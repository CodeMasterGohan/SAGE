# ============================================================================
#     ðŸŽ® EXTERNAL GPU SERVER CONFIGURATION
# ============================================================================
# To use external GPU servers for embeddings and PDF processing:
#
# 1. Copy .env.example to .env
# 2. Set your GPU server URLs:
#    - VLLM_EMBEDDING_URL=http://your-gpu-server:8000  (for embeddings)
#    - OLMOCR_SERVER=http://your-gpu-server:8000/v1   (for PDF processing)
#
# 3. Change EMBEDDING_MODE=local to EMBEDDING_MODE=remote in services below
# 4. Run: docker-compose up -d
#
# See .env.example for detailed configuration options.
# ============================================================================

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: sage-docs-qdrant
    ports:
      - "6334:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

  dashboard:
    build: ./dashboard
    container_name: sage-docs-dashboard
    depends_on:
      - qdrant
    ports:
      - "8080:8080"
    volumes:
      - ./uploads:/app/uploads
      - ./dashboard/static:/app/static
      - ./sage_core:/app/sage_core
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - COLLECTION_NAME=sage_docs
      - JOBS_COLLECTION=sage_jobs
      - UPLOAD_DIR=/app/uploads
      # Upload constraints
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-52428800}
      - MAX_ZIP_ENTRIES=${MAX_ZIP_ENTRIES:-500}
      - MAX_ZIP_TOTAL_SIZE=${MAX_ZIP_TOTAL_SIZE:-209715200}
      - WORKER_PROCESSES=${WORKER_PROCESSES:-2}
      # ==================== EMBEDDING SETTINGS ====================
      # ðŸ‘‡ Change 'local' to 'remote' to use external GPU server
      - EMBEDDING_MODE=local
      - DENSE_MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
      - DENSE_VECTOR_SIZE=384
      - USE_NOMIC_PREFIX=false
      # ðŸ‘‡ SET THESE for remote GPU embeddings (requires EMBEDDING_MODE=remote)
      - VLLM_EMBEDDING_URL=${VLLM_EMBEDDING_URL:-}
      - VLLM_MODEL_NAME=${VLLM_MODEL_NAME:-nomic-ai/nomic-embed-text-v1.5}
      - VLLM_API_KEY=${VLLM_API_KEY:-}
      # ==================== PDF PROCESSING (GPU) ====================
      # ðŸ‘‡ SET OLMOCR_SERVER to use remote GPU for PDF processing
      - OLMOCR_SERVER=${OLMOCR_SERVER:-}
      - OLMOCR_API_KEY=${OLMOCR_API_KEY:-}
      - OLMOCR_MODEL=${OLMOCR_MODEL:-allenai/olmOCR-2-7B-1025-FP8}
    mem_limit: 6g
    memswap_limit: 8g
    restart: unless-stopped

  refinery:
    build: ./refinery
    container_name: sage-docs-refinery
    depends_on:
      - qdrant
    volumes:
      - ./uploads:/app/uploads
      - ./sage_core:/app/sage_core
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - COLLECTION_NAME=sage_docs
      - UPLOAD_DIR=/app/uploads
      - EMBEDDING_MODE=local
      - DENSE_MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
      - DENSE_VECTOR_SIZE=384
      - USE_NOMIC_PREFIX=false
      # ==================== PDF PROCESSING (GPU) ====================
      # ðŸ‘‡ SET OLMOCR_SERVER to use remote GPU for PDF processing
      - OLMOCR_SERVER=${OLMOCR_SERVER:-}
      - OLMOCR_API_KEY=${OLMOCR_API_KEY:-}
      - OLMOCR_MODEL=${OLMOCR_MODEL:-allenai/olmOCR-2-7B-1025-FP8}
    restart: unless-stopped

  mcp-server:
    build: ./mcp-server
    container_name: sage-docs-mcp
    depends_on:
      - qdrant
    ports:
      - "8000:8000"
      - "8090:8080"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - COLLECTION_NAME=sage_docs
      # ==================== EMBEDDING SETTINGS ====================
      # ðŸ‘‡ Change 'local' to 'remote' to use external GPU server
      - EMBEDDING_MODE=local
      - DENSE_MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
      - USE_NOMIC_PREFIX=false
      # ðŸ‘‡ SET THESE for remote GPU embeddings (requires EMBEDDING_MODE=remote)
      - VLLM_EMBEDDING_URL=${VLLM_EMBEDDING_URL:-}
      - VLLM_MODEL_NAME=${VLLM_MODEL_NAME:-nomic-ai/nomic-embed-text-v1.5}
      - VLLM_API_KEY=${VLLM_API_KEY:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
  # sage-proxy:
  #   build: ./mcpo
  #   container_name: sage-mcpo
  #   depends_on:
  #     - mcp-server
  #   network_mode: service:mcp-server
  #   entrypoint: [ "/bin/sh", "-c" ]
  #   command: >
  #     "echo 'Waiting for mcp-server...' && 
  #      until curl -s http://localhost:8000/health > /dev/null || curl -s http://localhost:8000/sse > /dev/null || curl -s http://localhost:8000/ > /dev/null; do
  #        echo 'mcp-server not ready, sleeping 2s...'
  #        sleep 2
  #      done &&
  #      echo 'mcp-server is up!' &&
  #      exec mcpo --server-type streamable_http --port 8080 --host 0.0.0.0 -- http://localhost:8000/sse"

volumes:
  qdrant_data:
